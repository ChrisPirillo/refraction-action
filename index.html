<!DOCTYPE html>
<html lang="en"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-1CQ4D3VQ3L"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1CQ4D3VQ3L');
  </script>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="dns-prefetch" href="https://www.googletagmanager.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
<link rel="preconnect" href="https://www.googletagmanager.com">

<title>Refraction Action: Glass Lattice Voronoi Explorer</title>

<meta name="description" content="Create stunning generative art with this 3D Voronoi lattice explorer featuring physically-inspired refraction, custom environment maps, and 4K exports.">
<meta name="keywords" content="WebGL, Voronoi, Generative Art, Refraction, 3D Shaders, Visualizer, Creative Coding, Raymarching">
<meta name="author" content="Chris Pirillo">
<meta name="robots" content="index, follow, max-image-preview:large">
<meta name="theme-color" content="#0f172a">
<meta name="application-name" content="Refraction Action: Glass Lattice Voronoi Explorer">
<meta name="apple-mobile-web-app-title" content="Refraction Action: Glass Lattice Voronoi Explorer">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">

<meta property="og:site_name" content="Chris Pirillo's Arcade">
<meta property="og:type" content="website">
<meta property="og:title" content="Refraction Action: Glass Lattice Voronoi Explorer">
<meta property="og:description" content="Create stunning generative art with this 3D Voronoi lattice explorer featuring physically-inspired refraction, custom environment maps, and 4K exports.">
<meta property="og:url" content="https://arcade.pirillo.com/refraction-action.html">
<meta property="og:image" content="https://arcade.pirillo.com/images/refraction-action.png">
<meta property="og:image:alt" content="Refraction Action: Glass Lattice Voronoi Explorer">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2026-02-26T21:47:36.430Z">
<meta property="article:author" content="Chris Pirillo">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@ChrisPirillo">
<meta name="twitter:creator" content="@ChrisPirillo">
<meta name="twitter:title" content="Refraction Action: Glass Lattice Voronoi Explorer">
<meta name="twitter:description" content="Create stunning generative art with this 3D Voronoi lattice explorer featuring physically-inspired refraction, custom environment maps, and 4K exports.">
<meta name="twitter:image" content="https://arcade.pirillo.com/images/refraction-action.png">
<meta name="twitter:domain" content="arcade.pirillo.com">
<meta name="twitter:url" content="https://arcade.pirillo.com/refraction-action.html">

<link rel="canonical" href="https://arcade.pirillo.com/refraction-action.html">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/icon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.json">

<script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Refraction Action: Glass Lattice Voronoi Explorer",
  "description": "Create stunning generative art with this 3D Voronoi lattice explorer featuring physically-inspired refraction, custom environment maps, and 4K exports.",
  "url": "https://arcade.pirillo.com/refraction-action.html",
  "image": "https://arcade.pirillo.com/images/refraction-action.png",
  "primaryImageOfPage": {
    "@type": "ImageObject",
    "url": "https://arcade.pirillo.com/images/refraction-action.png"
  },
  "datePublished": "2026-02-26T21:47:36.430Z",
  "dateModified": "2026-02-26T21:47:36.430Z",
  "author": {
    "@type": "Person",
    "name": "Chris Pirillo",
    "url": "https://pirillo.com",
    "sameAs": [
      "https://x.com/ChrisPirillo",
      "https://linkedin.com/in/chrispirillo"
    ]
  },
  "publisher": {
    "@type": "Organization",
    "name": "Chris Pirillo",
    "logo": {
      "@type": "ImageObject",
      "url": "https://pirillo.com/logo.png"
    }
  },
  "mainEntity": {
    "@type": "WebApplication",
    "name": "Refraction Action: Glass Lattice Voronoi Explorer",
    "description": "Create stunning generative art with this 3D Voronoi lattice explorer featuring physically-inspired refraction, custom environment maps, and 4K exports.",
    "image": "https://arcade.pirillo.com/images/refraction-action.png",
    "operatingSystem": "Any",
    "applicationCategory": "Simulation",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD",
      "availability": "https://schema.org/InStock"
    },
    "author": {
      "@type": "Person",
      "name": "Chris Pirillo",
      "url": "https://pirillo.com"
    },
    "datePublished": "2026-02-26T21:47:36.430Z",
    "inLanguage": "en-US"
  }
}</script>

<meta charset="UTF-8">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com&amp;display=swap">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet">
<style>:root { --glass-bg: rgba(10, 10, 12, 0.85); --glass-border: rgba(255, 255, 255, 0.1); --accent: #ff3333; }
body { margin: 0; overflow: hidden; background: #000; font-family: 'Inter', sans-serif; color: #eee; user-select: none; -webkit-user-select: none; }
canvas { display: block; width: 100vw; height: 100vh; touch-action: none; z-index: 0; }
.fade-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; pointer-events: none; opacity: 0; transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1); z-index: 40; }
.fade-overlay.active { opacity: 1; }
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 10px; }
input[type="range"] { -webkit-appearance: none; background: rgba(255, 255, 255, 0.08); height: 4px; border-radius: 2px; accent-color: var(--accent); }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 0 15px rgba(0,0,0,0.6); border: 2px solid var(--accent); }
.glass-panel { background: var(--glass-bg); backdrop-filter: blur(32px) saturate(180%); -webkit-backdrop-filter: blur(32px) saturate(180%); border-left: 1px solid var(--glass-border); box-shadow: -15px 0 45px rgba(0,0,0,0.7); }
.glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 14px; padding: 18px; transition: all 0.2s ease; }
.glass-card:hover { background: rgba(255, 255, 255, 0.05); }
.menu-btn { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1); }
.menu-btn:hover { background: rgba(255, 255, 255, 0.12); transform: scale(1.05); }
.sticky-header { background: rgba(10, 10, 12, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border); }
.btn-primary { background: var(--accent); color: white; font-weight: 600; transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; }
.btn-primary:hover { filter: brightness(1.15); box-shadow: 0 0 20px rgba(255, 51, 51, 0.3); }
.btn-secondary { background: rgba(255, 255, 255, 0.06); border: 1px solid rgba(255, 255, 255, 0.08); font-weight: 500; transition: all 0.2s ease; font-size: 0.75rem; }
#imageUploadLabel { cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; background: rgba(255, 255, 255, 0.05); border: 1px dashed rgba(255, 255, 255, 0.2); border-radius: 10px; font-size: 11px; color: rgba(255, 255, 255, 0.6); transition: all 0.2s ease; }</style>
</head>
<body><h1 style="display: none;">Refraction Action: Glass Lattice Voronoi Explorer</h1>

    <div id="fadeOverlay" class="fade-overlay"></div>
    <canvas id="glCanvas"></canvas>

    <!-- Menu Trigger -->
    <div class="fixed top-6 right-6 z-[60]">
        <button id="menuToggle" class="menu-btn w-12 h-12 flex flex-col items-center justify-center gap-1.5 rounded-2xl">
            <span class="w-6 h-0.5 bg-white rounded-full"></span>
            <span class="w-4 h-0.5 bg-white/70 rounded-full self-start ml-3"></span>
            <span class="w-6 h-0.5 bg-white rounded-full"></span>
        </button>
    </div>

    <!-- Settings Panel -->
    <aside id="settingsPanel" class="fixed top-0 right-0 h-full w-full sm:w-[440px] glass-panel z-[70] transform translate-x-full transition-transform duration-500 ease-[cubic-bezier(0.16,1,0.3,1)] flex flex-col">
        <header class="sticky-header h-20 flex items-center justify-between px-8 shrink-0">
            <div class="flex items-center gap-4">
                <h2 class="text-xl font-semibold tracking-tight text-white/95">Refraction Action</h2>
                <button id="infoBtn" class="w-5 h-5 rounded-full border border-white/20 flex items-center justify-center text-[10px] text-white/40 hover:text-white hover:border-white/60 transition-all">?</button>
            </div>
            <button id="closeMenu" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-xl transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"></path></svg>
            </button>
        </header>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-8 space-y-10 pb-10">
            <!-- Glass & Optics -->
            <section class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold uppercase tracking-[0.25em] text-white/25">Glass &amp; Optics</span>
                    <div class="h-px flex-1 bg-white/5"></div>
                </div>
                <div class="glass-card space-y-6">
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Zoom</span><span id="v_zoom" class="text-white">1.0</span></div>
                        <input type="range" id="zoom" min="0.5" max="3.5" step="0.01" value="1.0" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Render Depth</span><span id="v_farPlane" class="text-white">3.0</span></div>
                        <input type="range" id="farPlane" min="3.0" max="8.0" step="0.1" value="3.0" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Refraction Index</span><span id="v_ior" class="text-white">1.45</span></div>
                        <input type="range" id="ior" min="1.0" max="2.0" step="0.01" value="1.45" class="w-full">
                    </div>
                </div>
            </section>

            <!-- Custom Reflection Source -->
            <section class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold uppercase tracking-[0.25em] text-white/25">Environment</span>
                    <div class="h-px flex-1 bg-white/5"></div>
                </div>
                <div class="glass-card space-y-5">
                    <label id="imageUploadLabel">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        Upload Custom Environment
                        <input type="file" id="imageUpload" class="hidden" accept="image/*">
                    </label>
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Reflection Strength</span><span id="v_envStrength" class="text-white">1.0</span></div>
                        <input type="range" id="envStrength" min="0.0" max="3.0" step="0.1" value="1.0" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Light Offset</span><span id="v_lightZ" class="text-white">-1.0</span></div>
                        <input type="range" id="lightZ" min="-5.0" max="0.0" step="0.1" value="-1.0" class="w-full">
                    </div>
                </div>
            </section>

            <!-- Geometry -->
            <section class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold uppercase tracking-[0.25em] text-white/25">Geometry</span>
                    <div class="h-px flex-1 bg-white/5"></div>
                </div>
                <div class="glass-card space-y-6">
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Voronoi Freq</span><span id="v_voronoiScale" class="text-white">4.0</span></div>
                        <input type="range" id="voronoiScale" min="1.0" max="15.0" step="0.1" value="4.0" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Web Strength</span><span id="v_latticeThreshold" class="text-white">0.07</span></div>
                        <input type="range" id="latticeThreshold" min="0.01" max="0.25" step="0.001" value="0.07" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Height Factor</span><span id="v_hScale" class="text-white">0.10</span></div>
                        <input type="range" id="hScale" min="0.01" max="0.5" step="0.01" value="0.1" class="w-full">
                    </div>
                </div>
            </section>

            <!-- Aesthetics -->
            <section class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold uppercase tracking-[0.25em] text-white/25">Atmosphere</span>
                    <div class="h-px flex-1 bg-white/5"></div>
                </div>
                <div class="glass-card space-y-6">
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Hue Shift</span><span id="v_hue" class="text-white">0.0</span></div>
                        <input type="range" id="hue" min="0.0" max="6.28" step="0.01" value="0.0" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Contrast</span><span id="v_contrast" class="text-white">1.0</span></div>
                        <input type="range" id="contrast" min="0.5" max="3.0" step="0.1" value="1.0" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Specular Glint</span><span id="v_specStrength" class="text-white">1.0</span></div>
                        <input type="range" id="specStrength" min="0.0" max="3.0" step="0.1" value="1.0" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Edge Contrast</span><span id="v_edgeSoft" class="text-white">0.8</span></div>
                        <input type="range" id="edgeSoft" min="0.01" max="1.5" step="0.01" value="0.8" class="w-full">
                    </div>
                </div>
            </section>

            <!-- Motion -->
            <section class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold uppercase tracking-[0.25em] text-white/25">Automation</span>
                    <div class="h-px flex-1 bg-white/5"></div>
                </div>
                <div class="glass-card space-y-6">
                    <div>
                        <div class="flex justify-between text-[11px] font-medium text-white/40 mb-3 uppercase tracking-wider"><span>Spin Speed</span><span id="v_rotSpeed" class="text-white">1.0</span></div>
                        <input type="range" id="rotSpeed" min="0.0" max="3.0" step="0.1" value="1.0" class="w-full">
                    </div>
                    <div class="flex items-center justify-between pt-2">
                        <span class="text-xs font-medium text-white/70">Flux Cycle</span>
                        <input type="checkbox" id="autoRandomize" class="w-5 h-5 rounded-lg border-white/10 bg-white/5 checked:bg-red-500 appearance-none transition-all cursor-pointer border ring-offset-black checked:ring-4 ring-red-500/20">
                    </div>
                </div>
            </section>
        </div>

        <footer class="p-8 border-t border-white/10 glass-panel bg-black/60 space-y-4 shrink-0">
            <div class="grid grid-cols-2 gap-4">
                <button id="randomizeBtn" class="btn-primary py-3.5 rounded-2xl active:scale-95 transition-transform">Randomize</button>
                <button id="resetBtn" class="btn-secondary py-3.5 rounded-2xl text-white/60 active:scale-95 transition-transform">Default</button>
            </div>
            <button id="exportWallpaper" class="w-full py-3 bg-white/5 hover:bg-white/10 border border-white/5 rounded-2xl text-xs font-semibold uppercase tracking-widest transition-all">Export 4K Artifact</button>
            <div class="grid grid-cols-2 gap-3 pt-1">
                <button id="exportSettings" class="py-2.5 text-[9px] font-black uppercase tracking-widest bg-white/5 hover:bg-white/10 rounded-xl border border-white/5">Save Config</button>
                <button id="importSettings" class="py-2.5 text-[9px] font-black uppercase tracking-widest bg-white/5 hover:bg-white/10 rounded-xl border border-white/5">Load Config</button>
            </div>
        </footer>
    </aside>

    <!-- Centered Info Modal with Full Links -->
    <div id="infoModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-6 bg-black/90 backdrop-blur-3xl">
        <div class="bg-[#0b0b0d] border border-white/10 rounded-[40px] p-10 sm:p-12 max-w-md w-full relative space-y-8 shadow-2xl overflow-y-auto max-h-[90vh] flex flex-col">
            <button id="closeInfo" class="absolute top-8 right-8 text-white/20 hover:text-white transition-colors">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg>
            </button>
            <div class="space-y-4 text-center">
                <h3 class="text-4xl font-bold tracking-tighter italic uppercase">Refraction Action</h3>
                <p class="text-white/40 text-sm leading-relaxed font-light">Physically-inspired refraction and reflection using custom environmental maps and 3D SDF geometry.</p>
                <p class="text-[11px] text-white/20 uppercase tracking-[0.1em] mt-6">Original formula by Gabrie_Oreo</p>
            </div>
            <div class="grid grid-cols-1 gap-2 pt-4">
                <a href="https://arcade.pirillo.com/" target="_blank" class="py-3 px-4 text-[10px] font-bold uppercase tracking-widest bg-white/5 border border-white/5 rounded-xl text-center hover:bg-white/10 transition-all">More of My Apps</a>
                <a href="https://chris.pirillo.com/" target="_blank" class="py-3 px-4 text-[10px] font-bold uppercase tracking-widest bg-white/5 border border-white/5 rounded-xl text-center hover:bg-white/10 transition-all">Follow Chris Pirillo</a>
                <a href="https://ctrlaltcreate.live/" target="_blank" class="py-3 px-4 text-[10px] font-bold uppercase tracking-widest bg-white/5 border border-white/5 rounded-xl text-center hover:bg-white/10 transition-all">Learn How to Make Apps</a>
                <div class="grid grid-cols-2 gap-2">
                    <a href="https://www.paypal.com/donate/?hosted_button_id=UMWCDWGVXVHZU" target="_blank" class="py-3 px-4 text-[10px] font-bold uppercase tracking-widest bg-red-500/10 text-red-400 border border-red-500/20 rounded-xl text-center hover:bg-red-500/20 transition-all">Donate</a>
                    <a href="https://patreon.com/ChrisPirillo" target="_blank" class="py-3 px-4 text-[10px] font-bold uppercase tracking-widest bg-blue-500/10 text-blue-400 border border-blue-500/20 rounded-xl text-center hover:bg-blue-500/20 transition-all">Patreon</a>
                </div>
            </div>
        </div>
    </div>

    <script id="vertexShader" type="x-shader/x-vertex">
        attribute vec2 position;
        void main() { gl_Position = vec4(position, 0.0, 1.0); }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">
        precision highp float;
        uniform vec2 iResolution;
        uniform float iTime;
        uniform float u_far;
        uniform float u_vScale;
        uniform float u_lThreshold;
        uniform float u_edgeStrength;
        uniform float u_specStrength;
        uniform float u_envStrength;
        uniform float u_hue;
        uniform float u_ior;
        uniform float u_rotSpeed;
        uniform float u_rotDir;
        uniform float u_contrast;
        uniform float u_heightScale;
        uniform float u_lightZ;
        uniform float u_zoom;
        uniform sampler2D u_envTex;
        uniform bool u_hasTex;

        int id = 0;

        vec3 rotHue(vec3 p, float a){
            vec2 cs = sin(vec2(1.570796, 0) + a);
            mat3 hr = mat3(0.299,  0.587,  0.114,  0.299,  0.587,  0.114,  0.299,  0.587,  0.114) +
                      mat3(0.701, -0.587, -0.114, -0.299,  0.413, -0.114, -0.300, -0.588,  0.886) * cs.x +
                      mat3(0.168,  0.330, -0.497, -0.328,  0.035,  0.292,  1.250, -1.050, -0.203) * cs.y;
            return clamp(p*hr, 0., 1.);
        }

        float n3D(vec3 p){
            const vec3 s = vec3(7, 157, 113);
            vec3 ip = floor(p); p -= ip; 
            vec4 h = vec4(0., s.yz, s.y + s.z) + dot(ip, s);
            p = p*p*(3. - 2.*p);
            h = mix(fract(sin(h)*43758.5453), fract(sin(h + s.x)*43758.5453), p.x);
            h.xy = mix(h.xz, h.yw, p.y);
            return mix(h.x, h.y, p.z);
        }

        vec2 hash22(vec2 p) { 
            float n = sin(dot(p, vec2(41, 289)));
            p = fract(vec2(262144, 32768)*n); 
            return sin( p*6.2831853 + iTime )*.45 + .5; 
        }

        float Voronoi(in vec2 p){
            vec2 g = floor(p), o; p -= g;
            vec3 d = vec3(1); 
            for(int y = -1; y <= 1; y++){
                for(int x = -1; x <= 1; x++){
                    o = vec2(x, y);
                    o += hash22(g + o) - p;
                    d.z = dot(o, o); 
                    d.y = max(d.x, min(d.y, d.z));
                    d.x = min(d.x, d.z); 
                }
            }
            return max(d.y/1.2 - d.x*1., 0.)/1.2;
        }

        float heightMap(vec3 p){
            id = 0;
            float c = Voronoi(p.xy * u_vScale);
            if (c < u_lThreshold) {
                c = smoothstep(0.7, 1., 1. - c) * .2; 
                id = 1; 
            }
            return c;
        }

        float m(vec3 p){
            float h = heightMap(p);
            return 1. - p.z - h * u_heightScale;
        }

        vec3 nr(vec3 p, inout float edge) { 
            vec2 e = vec2(.005, 0);
            float d1 = m(p + e.xyy), d2 = m(p - e.xyy);
            float d3 = m(p + e.yxy), d4 = m(p - e.yxy);
            float d5 = m(p + e.yyx), d6 = m(p - e.yyx);
            float d = m(p)*2.; 
            edge = abs(d1 + d2 - d) + abs(d3 + d4 - d) + abs(d5 + d6 - d);
            edge = smoothstep(0., 1., sqrt(edge/e.x*2.));
            return normalize(vec3(d1 - d2, d3 - d4, d5 - d6));
        }

        vec3 eMap(vec3 rd){
            if(u_hasTex){
                vec2 uv = vec2(atan(rd.z, rd.x) / 6.2831 + 0.5, acos(rd.y) / 3.1415);
                return texture2D(u_envTex, uv).rgb * u_envStrength;
            }
            vec3 sRd = rd;
            rd.xy -= iTime*.25;
            rd *= 3.;
            float c = n3D(rd)*.57 + n3D(rd*2.)*.28 + n3D(rd*4.)*.15;
            c = smoothstep(0.5, 1., c);
            vec3 col = vec3(min(c*1.5, 1.), pow(c, 2.5), pow(c, 12.)).zyx;
            return mix(col, col.yzx, sRd*.25+.25) * u_envStrength;
        }

        void main() {
            vec2 u = gl_FragCoord.xy;
            vec3 r = normalize(vec3(u - iResolution.xy*.5, iResolution.y * (1.0/u_zoom)));
            vec3 o = vec3(0); 
            vec3 l = o + vec3(0, 0, u_lightZ);

            float rT = iTime * u_rotSpeed * u_rotDir / 8.0;
            vec2 a = sin(vec2(1.570796, 0) + rT);
            r.xy = mat2(a, -a.y, a.x) * r.xy;

            float d, t = 0.;
            for(int i=0; i<32; i++){
                d = m(o + r*t);
                if(abs(d)<0.001 || t>u_far) break;
                t += d*.7;
            }
            t = min(t, u_far);

            vec4 color = vec4(0,0,0,1);
            float edge = 0.;

            if(t < u_far){
                vec3 p = o + r*t;
                vec3 n = nr(p, edge);
                
                float hm = heightMap(p);
                float gray = smoothstep(0., 1., hm);
                vec3 baseColor = vec3(1.);
                if (id == 0) {
                    float exp1 = 5.0 / u_contrast;
                    float exp2 = 24.0 / u_contrast;
                    baseColor = vec3(min(gray*1.5, 1.), pow(gray, exp1), pow(gray, exp2)) * 2.;
                } else {
                    baseColor *= 0.1;
                }
                baseColor = rotHue(baseColor, u_hue);

                vec3 refVec = reflect(r, n);
                vec3 refCol = eMap(refVec);
                vec3 refrVec = refract(r, n, 1.0 / u_ior);
                vec3 refrCol = eMap(refrVec);

                float fr = pow(clamp(1.0 + dot(r, n), 0.0, 1.0), 5.0);
                color.rgb = mix(refrCol * baseColor, refCol, fr);
                
                vec3 lDir = normalize(l - p);
                float sp = pow(max(dot(reflect(-lDir, n), -r), 0.0), 32.0) * u_specStrength;
                color.rgb += vec3(1, .97, .92) * sp;

                color.xyz *= 1. - edge * u_edgeStrength;
            } else {
                color.rgb = eMap(r) * 0.2;
            }

            gl_FragColor = vec4(sqrt(clamp(color.xyz, 0., 1.)), 1.0);
        }
    </script>

    <script>
        const canvas = document.getElementById('glCanvas');
        const gl = canvas.getContext('webgl', { preserveDrawingBuffer: true });
        const fadeOverlay = document.getElementById('fadeOverlay');

        let program, uniforms = {}, currentTime = 0, lastTime = 0, isTransitioning = false;
        let envTexture = null;

        const state = {
            zoom: 1.0, voronoiScale: 4.0, latticeThreshold: 0.07, farPlane: 3.0,
            hue: 0.0, contrast: 1.0, edgeStrength: 0.8, specStrength: 1.0,
            envStrength: 1.0, ior: 1.45, rotSpeed: 1.0, rotDir: 1.0,
            timeScale: 1.0, autoRandomize: false, hScale: 0.1, lightZ: -1.0
        };

        const defaultState = JSON.parse(JSON.stringify(state));

        function initGL() {
            const vs = gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(vs, document.getElementById('vertexShader').text);
            gl.compileShader(vs);
            const fs = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(fs, document.getElementById('fragmentShader').text);
            gl.compileShader(fs);
            program = gl.createProgram();
            gl.attachShader(program, vs); gl.attachShader(program, fs);
            gl.linkProgram(program); gl.useProgram(program);
            const buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]), gl.STATIC_DRAW);
            const pos = gl.getAttribLocation(program, 'position');
            gl.enableVertexAttribArray(pos); gl.vertexAttribPointer(pos, 2, gl.FLOAT, false, 0, 0);
            uniforms = {
                res: gl.getUniformLocation(program, 'iResolution'), time: gl.getUniformLocation(program, 'iTime'),
                far: gl.getUniformLocation(program, 'u_far'), vScale: gl.getUniformLocation(program, 'u_vScale'),
                lThreshold: gl.getUniformLocation(program, 'u_lThreshold'), edge: gl.getUniformLocation(program, 'u_edgeStrength'),
                spec: gl.getUniformLocation(program, 'u_specStrength'), env: gl.getUniformLocation(program, 'u_envStrength'),
                hue: gl.getUniformLocation(program, 'u_hue'), ior: gl.getUniformLocation(program, 'u_ior'),
                rotSpeed: gl.getUniformLocation(program, 'u_rotSpeed'), rotDir: gl.getUniformLocation(program, 'u_rotDir'),
                contrast: gl.getUniformLocation(program, 'u_contrast'), 
                zoom: gl.getUniformLocation(program, 'u_zoom'), envTex: gl.getUniformLocation(program, 'u_envTex'),
                hasTex: gl.getUniformLocation(program, 'u_hasTex'), hScale: gl.getUniformLocation(program, 'u_heightScale'),
                lightZ: gl.getUniformLocation(program, 'u_lightZ')
            };
        }

        function createTexture(image) {
            if (envTexture) gl.deleteTexture(envTexture);
            envTexture = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, envTexture);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
        }

        function render() {
            const now = Date.now();
            const dt = (now - (lastTime || now)) / 1000;
            lastTime = now;
            currentTime += dt * state.timeScale;
            gl.viewport(0, 0, canvas.width, canvas.height);
            gl.uniform2f(uniforms.res, canvas.width, canvas.height);
            gl.uniform1f(uniforms.time, currentTime);
            gl.uniform1f(uniforms.far, state.farPlane);
            gl.uniform1f(uniforms.vScale, state.voronoiScale);
            gl.uniform1f(uniforms.lThreshold, state.latticeThreshold);
            gl.uniform1f(uniforms.edge, state.edgeStrength);
            gl.uniform1f(uniforms.spec, state.specStrength);
            gl.uniform1f(uniforms.env, state.envStrength);
            gl.uniform1f(uniforms.hue, state.hue);
            gl.uniform1f(uniforms.ior, state.ior);
            gl.uniform1f(uniforms.rotSpeed, state.rotSpeed);
            gl.uniform1f(uniforms.rotDir, state.rotDir);
            gl.uniform1f(uniforms.contrast, state.contrast);
            gl.uniform1f(uniforms.zoom, state.zoom);
            gl.uniform1f(uniforms.hScale, state.hScale);
            gl.uniform1f(uniforms.lightZ, state.lightZ);
            gl.uniform1i(uniforms.hasTex, envTexture !== null);
            if(envTexture) {
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, envTexture);
                gl.uniform1i(uniforms.envTex, 0);
            }
            gl.drawArrays(gl.TRIANGLES, 0, 6);
            requestAnimationFrame(render);
        }

        function resize() {
            canvas.width = window.innerWidth * window.devicePixelRatio;
            canvas.height = window.innerHeight * window.devicePixelRatio;
        }

        function updateUI() {
            const sync = (id, val, fixed = 1) => {
                const input = document.getElementById(id);
                const label = document.getElementById('v_' + id);
                if (input) input.value = val;
                if (label) label.innerText = val.toFixed(fixed);
            };
            sync('zoom', state.zoom, 2); sync('voronoiScale', state.voronoiScale);
            sync('farPlane', state.farPlane); sync('hue', state.hue, 2);
            sync('latticeThreshold', state.latticeThreshold, 3); sync('contrast', state.contrast, 1);
            sync('ior', state.ior, 2); sync('edgeSoft', state.edgeStrength, 2);
            sync('rotSpeed', state.rotSpeed, 1); sync('envStrength', state.envStrength, 1);
            sync('specStrength', state.specStrength, 1);
            sync('hScale', state.hScale, 2); sync('lightZ', state.lightZ, 1);
            document.getElementById('autoRandomize').checked = state.autoRandomize;
        }

        async function randomize(silent = false) {
            if (isTransitioning) return;
            isTransitioning = true;
            if (!silent) fadeOverlay.classList.add('active');
            await new Promise(r => setTimeout(r, silent ? 0 : 500));
            state.zoom = 0.5 + Math.random() * 3.0;
            state.voronoiScale = 1.0 + Math.random() * 12.0;
            state.latticeThreshold = 0.02 + Math.random() * 0.2;
            state.farPlane = 3.0 + Math.random() * 5.0;
            state.hue = Math.random() * 6.28;
            state.contrast = 0.5 + Math.random() * 2.0;
            state.ior = 1.1 + Math.random() * 0.8;
            state.rotSpeed = Math.random() * 2.5;
            state.rotDir = (Math.random() > 0.5 ? 1 : -1) * (0.2 + Math.random() * 0.8);
            state.envStrength = 0.5 + Math.random() * 2.0;
            state.hScale = 0.05 + Math.random() * 0.3;
            state.lightZ = -3.0 + Math.random() * 3.0;
            updateUI();
            if (!silent) {
                await new Promise(r => setTimeout(r, 100));
                fadeOverlay.classList.remove('active');
            }
            isTransitioning = false;
        }

        let menuOpen = false, lastTap = 0, initialPinchDist = 0, initialZoom = 1;
        const setMenu = (open) => {
            menuOpen = open;
            document.getElementById('settingsPanel').style.transform = open ? 'translateX(0)' : 'translateX(100%)';
        };

        window.onmousedown = (e) => {
            if (menuOpen && !document.getElementById('settingsPanel').contains(e.target) && !document.getElementById('menuToggle').contains(e.target)) {
                setMenu(false);
            }
        };

        window.onmouseup = (e) => {
            if (e.target === canvas && !menuOpen) randomize();
        };

        window.addEventListener('wheel', (e) => { 
            if(e.target === canvas) { 
                state.zoom = Math.max(0.5, Math.min(3.5, state.zoom + e.deltaY * 0.001)); 
                updateUI(); 
            } 
        }, {passive: true});

        canvas.ontouchstart = (e) => {
            const now = Date.now();
            if (now - lastTap < 300) randomize();
            lastTap = now;
            if (e.touches.length === 2) { 
                initialPinchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); 
                initialZoom = state.zoom; 
            }
        };

        canvas.ontouchmove = (e) => {
            if (e.touches.length === 2) { 
                const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); 
                state.zoom = Math.max(0.5, Math.min(3.5, initialZoom * (d / initialPinchDist))); 
                updateUI(); 
            }
        };

        document.getElementById('imageUpload').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const img = new Image();
            img.onload = () => createTexture(img);
            img.src = URL.createObjectURL(file);
        };

        document.getElementById('menuToggle').onclick = () => setMenu(true);
        document.getElementById('closeMenu').onclick = () => setMenu(false);
        document.getElementById('randomizeBtn').onclick = () => randomize();
        document.getElementById('resetBtn').onclick = () => { Object.assign(state, JSON.parse(JSON.stringify(defaultState))); envTexture = null; updateUI(); };

        const bindRange = (id, key, fixed = 1) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.oninput = () => { state[key] = parseFloat(el.value); const lbl = document.getElementById('v_' + id); if (lbl) lbl.innerText = state[key].toFixed(fixed); };
        };
        bindRange('zoom', 'zoom', 2); bindRange('voronoiScale', 'voronoiScale'); bindRange('latticeThreshold', 'latticeThreshold', 3);
        bindRange('farPlane', 'farPlane'); bindRange('hue', 'hue', 2); bindRange('contrast', 'contrast', 1);
        bindRange('ior', 'ior', 2); bindRange('edgeSoft', 'edgeStrength', 2); bindRange('rotSpeed', 'rotSpeed', 1);
        bindRange('envStrength', 'envStrength', 1); bindRange('specStrength', 'specStrength', 1);
        bindRange('hScale', 'hScale', 2); bindRange('lightZ', 'lightZ', 1);

        document.getElementById('autoRandomize').onchange = (e) => { state.autoRandomize = e.target.checked; resetAutoTimer(); };
        const infoModal = document.getElementById('infoModal');
        document.getElementById('infoBtn').onclick = () => { infoModal.classList.remove('hidden'); infoModal.classList.add('flex'); };
        document.getElementById('closeInfo').onclick = () => { infoModal.classList.add('hidden'); infoModal.classList.remove('flex'); };
        window.onkeydown = (e) => { if (e.key === 'Escape') { if(!infoModal.classList.contains('hidden')) { infoModal.classList.add('hidden'); infoModal.classList.remove('flex'); } else { setMenu(false); } } };

        document.getElementById('exportWallpaper').onclick = () => {
            const ow = canvas.width, oh = canvas.height;
            canvas.width = 3840; canvas.height = 2160; gl.viewport(0,0,3840,2160); render();
            const link = document.createElement('a'); link.download = `Artifact_${Date.now()}.png`; link.href = canvas.toDataURL(); link.click();
            canvas.width = ow; canvas.height = oh; resize();
        };

        document.getElementById('exportSettings').onclick = () => {
            const link = document.createElement('a'); link.download = `Lattice_Config_${Date.now()}.json`;
            link.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); link.click();
        };

        document.getElementById('importSettings').onclick = () => {
            const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => { try { Object.assign(state, JSON.parse(ev.target.result)); updateUI(); } catch(e) {} };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        };

        let autoTimer;
        function resetAutoTimer() { clearInterval(autoTimer); if (state.autoRandomize) autoTimer = setInterval(() => randomize(), 10000); }

        window.onload = () => { initGL(); resize(); randomize(true); render(); resetAutoTimer(); };
        window.onresize = resize;
    </script>

</body></html>